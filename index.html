<!doctype html>
<html>
  <head>
	<title>Socket.IO chat</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	<script>
	$(function () {
				var socket = io();
				let users = $('#users');
				let messages = $('#messages');
				$('form').submit(function(e){
					e.preventDefault(); // prevents page reloading
					socket.emit('chat message', $('#m').val(), Cookies.get("nickname"));
					$('#m').val('');
					return false;
				});

				socket.on('user update', function(user_list){
					//console.log("user connected", user);
					users.empty();
					for(user in user_list)
					{
						users.append($('<li>').text(user_list[user]).addClass("list-group-item"));
					}
				});
				
				socket.on('username', function(username){
					console.log("username", username);
					document.cookie = "nickname="+username+";";
				});
				
				
				/*socket.on('user disconnected', function(user){
					console.log("user disconnected", users);
					$('#users').innerHTML('');
					for(user in users)
					{
						console.log(user);
						$('#users').append($('<li>').text(users[user]));
					}
				});*/
				
										
				socket.on('chat message', function(msg){
					console.log("Message recieved", msg);
					let time = new Date(msg.time).toLocaleTimeString('en-US');
					messages.append($('<div>').append($('<div>').text(time+ ": "+ msg.msg)));

					console.log(messages.scrollTop());
					console.log(($('#messages')[0].scrollHeight - messages.height()) - messages.scrollTop());
					if((messages[0].scrollHeight - messages.height()) - messages.scrollTop() < 200 || messages.scrollTop() == 0)
					{
						messages.scrollTop($('#messages')[0].scrollHeight);
					}
					if(msg.user === Cookies.get("nickname"))
					{
						messages.scrollTop($('#messages')[0].scrollHeight);
						$('#messages div').last().addClass('user-messages');
					}

				});
			
			});
	</script>
	<style>
	
		
body { 
	font: 15px; 
	font-family: sans-serif;
}
form { background: #000; padding: 3px; height: 5vh; position: absolute; bottom: 0; width: 100%; }
form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
#messages { 
    list-style-type: none;
     margin: 0; 
     padding: 0; 
     width: 100%; 
     text-align: start;
    overflow-y: auto;
	height: 95vh;
	scroll-behavior: smooth;
}

#messages div { 
	padding: 10px;
	display: flex;
}
#messages div div{ 
	background: #21212151;
	border-radius: 25px;
	max-width: 50%;
}

#users { 
	margin: 0; 
	padding: 0; 
	width: 100%; 
	text-align: start;
	height: 95vh;
	list-style: none;
}

#message-box{
height: 100vh;
width: 75%;
display: flex;
position: relative;
}

#member-box{
width: 25%;
height: 100vh;
border-left: 1px solid #919191;
background: #e1e1e1;
}

#full-window{
width: 100%;
display: inline-flex;
}

.user-messages{
	color: red !important;
	text-align: end;
	justify-content: end;
}
	
</style>
  </head>
  <body>
  	<div id="full-window">
  	<div id="message-box">
    <div id="messages">

	</div>
    <br/>
     <form action="">
      <input id="m" autocomplete="off" /><button class="btn btn-primary">Send</button>
    </form>
    </div>
    <div id="member-box">
    <ul id="users" class="list-group list-group-flush"></ul>
    </div>
		</div>
    
  </body>
</html>

